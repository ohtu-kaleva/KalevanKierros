<%= bootstrap_form_for(@enrollment) do |f| %>
    <% if @enrollment.errors.any? %>
        <div id="error_explanation">
          <h2><%= pluralize(@enrollment.errors.count, "error") %> prohibited this enrollment being created!</h2>

        <ul>
          <% @enrollment.errors.full_messages.each do |message| %>
              <li><%= message %></li>
          <% end %>
        </ul>
        </div>
    <% end %>
    <h2><%= @event.name %></h2>
    <p style="white-space: pre-wrap;">
        <%= @event.description %>
    </p>
    <% event_price = @event.current_price %>
    <% if event_price and event_price > 0 %>
        <p>
            <input type="radio" checked="true"/>
            <span id="event_price" class="hidden"><%= event_price %></span>
            Osallistumismaksu (<%= "%.2f" % (event_price/100.0) %> euroa)
        </p>
    <% end %>
    <div class="field">
    <% @event.event_attributes.each do |e| %>
        <% if e.attribute_type == "select" or e.attribute_type == "radio_button" %>
            <p><%= e.attribute_label %></p>
        <% end %>

        <% if e.attribute_type == "select" %>
          <p>
            <%= select_tag(e.name, options_for_select(e.get_options_to_form), {:class => 'payfield', "data-prices" => e.get_prices.to_s}) %><br>
          </p>
        <% end %>
        <% if e.attribute_type == "radio_button" %>
          <p>
            <% i = 0 %>
              <% checked = true %>
              <% e.get_options_to_form.each do |v, p| %>
                  <%= radio_button_tag(e.name, p, checked, {:class => 'payfield', "data-prices" => e.get_prices.to_s, "data-index" => i}) %>
                  <%= label_tag(e.attribute_label, v) %><br>
                  <% checked = false %>
                  <% i = i + 1 %>
              <% end %>
          </p>
        <% end %>
        <% if e.attribute_type == "check_box" %>
          <p>
            <% e.get_options_to_form.each do |v, p| %>
                <%= hidden_field_tag(e.name + '[]', "", {:class => 'payfield', "data-prices" => e.get_prices.to_s}) %>
                <%= check_box_tag(e.name + '[]', p, false, {:class => 'payfield', "data-prices" => e.get_prices.to_s}) %>
                <%= label_tag(e.attribute_label, v) %><br>
              <% end %>
          </p>
        <% end %>
        <% if e.attribute_type == "text_field" %>
        <p>
            <%= text_field_tag(e.name, e.attribute_value) %>
        </p>
        <% end %>
        <% if e.attribute_type == "plain_text" %>
          <p>
            <%= e.attribute_value %>
          </p>
        <% end %>
        <% if e.attribute_type == "date" %>
          <p>
            <%= date_select(e.name, nil) %>
          </p>
        <% end %>
    <% end %>
    <%= f.hidden_field :event_id, :value => params[:event_id] %>
    </div>
    <h4>
        <span id="price_sum"></span>
    </h4>
    <h1 class="actions">
      <%= submit_tag 'Ilmoittaudu tapahtumaan', :class => "btn btn-success", data: {disable_with: 'Ilmoittautuminen lähetetty'}  %>
    </h1>

    <script type="text/javascript">
        $(document).ready(function() {
            updateSum();
            $(".payfield").each(function() {
                $(this).change(function() {
                    updateSum();
                });
            });
        
            function updateSum() {
                var sum = 0;
                if ($("#event_price").length) {
                    sum = sum + parseInt($("#event_price").html())
                }
                $(".payfield").each(function() {
                    if($(this).is(":checkbox")) {
                        if($(this).is(":checked")) {
                            sum = sum + $(this).data("prices")[0];
                        }
                    } else if($(this).is("select")) {
                        var prices = $(this).data("prices");
                        sum = sum + prices[$(this)[0].selectedIndex];
                    } else if($(this).is(":radio")) {
                        var prices = $(this).data("prices");
                        if($(this).is(":checked")) {
                            sum = sum + $(this).data("prices")[ $(this).data('index')];
                        }
                    }
                });
                sum = sum/100
                if(sum > 0) {
                    $("#price_sum").html("Yhteensä: " + sum.toFixed(2) + " euroa");
                } else {
                    $("#price_sum").html("");
                }
            };     
        });
    </script>
<% end %>